{% extends 'base.html' %}

{% block main %}
    <main class="create-post-page">
        {% if object %}
            <h1>–ò–∑–º–µ–Ω–∏—Ç—å –ü–æ—Å—Ç {{ object.title }}</h1>
        {% else %}
            <h1>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
        {% endif %}

        <form class="post-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <label for="title">{{ form.title.label }}</label>
            {{ form.title }}
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
            <label for="content">{{ form.description.label }}</label>
            {{ form.description }}

            <!-- –¢–µ–≥–∏ -->
            <label for="tags">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏</label>
            {{ form.tags }}
            <small>–ó–∞–∂–º–∏—Ç–µ Ctrl (–∏–ª–∏ Cmd –Ω–∞ Mac), —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ</small>

            <label for="">–°—Ç–∞—Ç—É—Å</label>
            {{ form.status }}

            <!-- –ì–∞–ª–µ—Ä–µ—è -->
            <label for="images">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            {{ images.management_form }}
            {% for image_form in images %}
                {% if image_form.instance.pk %}
                    <div class="image-preview" id="imagePreview">
                        <img src="{{ image_form.instance.image.url }}" alt="" width="120px">
                    </div>
                {% endif %}
                {{ image_form.as_p }}
            {% endfor %}

            <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
            <div class="image-preview" id="imagePreview">
                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</p>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="form-actions">
                <button type="submit" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <a href="{% url 'index' %}" class="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>
    </main>
{% endblock %}

{% block scripts %}
    <script>
        const input = document.getElementById("images");
        const preview = document.getElementById("imagePreview");

        let filesArray = [];

        input.addEventListener("change", () => {
            filesArray = Array.from(input.files);
            renderPreviews();
        });

        function renderPreviews() {
            preview.innerHTML = "";
            if (filesArray.length === 0) {
                preview.innerHTML = "<p>–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã.</p>";
                return;
            }

            filesArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const wrapper = document.createElement("div");
                    wrapper.classList.add("preview-item");

                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.classList.add("preview-img");

                    const removeBtn = document.createElement("button");
                    removeBtn.innerHTML = "‚ùå";
                    removeBtn.classList.add("remove-btn");
                    removeBtn.onclick = () => {
                        filesArray.splice(index, 1);
                        updateFileInput();
                        renderPreviews();
                    };

                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    preview.appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            filesArray.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;
        }
    </script>
{% endblock %}